{
  "permissions": {
    "allow": [
      "Bash(ssh -o StrictHostKeyChecking=no root@72.61.52.70 \"echo ''ConexÃ£o estabelecida'' && uname -a && docker --version && docker-compose --version 2>/dev/null || docker compose version\")",
      "Bash(ssh root@72.61.52.70 \"mkdir -p /opt/mdm-validation && ls -la /opt/\")",
      "Bash(rsync:*)",
      "Bash(ssh root@72.61.52.70 \"cat > /opt/mdm-validation/backend/.env << ''EOF''\n# MongoDB\nMONGO_URI=mongodb://mongodb:27017/mdm_validation\n\n# JWT\nJWT_SECRET=Kj8mN2pQ5rT7vX9zA3cF6hJ0lM4nP8qS1uW5xY2bD\nJWT_EXPIRATION=60m\n\n# Server\nPORT=3001\nNODE_ENV=production\n\n# Upload\nMAX_FILE_SIZE_MB=50\n\n# Frontend URL (for CORS)\nFRONTEND_URL=http://72.61.52.70:5173\nEOF\")",
      "Bash(ssh root@72.61.52.70 \"cd /opt/mdm-validation && docker compose down 2>/dev/null; docker compose build --no-cache\")",
      "Bash(ssh root@72.61.52.70 \"cat > /opt/mdm-validation/backend/Dockerfile << ''EOF''\nFROM node:20-alpine\n\nWORKDIR /app\n\n# Copy package files\nCOPY package*.json ./\n\n# Install dependencies\nRUN npm install --omit=dev\n\n# Copy source code\nCOPY src ./src\n\n# Create uploads directory\nRUN mkdir -p uploads\n\n# Expose port\nEXPOSE 3001\n\n# Start the application\nCMD [\"\"node\"\", \"\"src/index.js\"\"]\nEOF\")",
      "Bash(ssh root@72.61.52.70 \"cat > /opt/mdm-validation/frontend/Dockerfile << ''EOF''\nFROM node:20-alpine AS builder\n\nWORKDIR /app\n\n# Copy package files\nCOPY package*.json ./\n\n# Install dependencies\nRUN npm install\n\n# Copy source code\nCOPY . .\n\n# Build the application\nRUN npm run build\n\n# Production stage\nFROM nginx:alpine\n\n# Copy custom nginx config\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\n# Copy built files\nCOPY --from=builder /app/dist /usr/share/nginx/html\n\n# Expose port\nEXPOSE 80\n\nCMD [\"\"nginx\"\", \"\"-g\"\", \"\"daemon off;\"\"]\nEOF\")",
      "Bash(ssh root@72.61.52.70 \"cat > /opt/mdm-validation/docker-compose.yml << ''EOF''\nservices:\n  # MongoDB\n  mongodb:\n    image: mongo:7.0\n    container_name: mdm-mongodb\n    restart: unless-stopped\n    environment:\n      MONGO_INITDB_DATABASE: mdm_validation\n    ports:\n      - \"\"27017:27017\"\"\n    volumes:\n      - mongodb_data:/data/db\n    networks:\n      - mdm-network\n\n  # Backend API\n  backend:\n    build:\n      context: ./backend\n      dockerfile: Dockerfile\n    container_name: mdm-backend\n    restart: unless-stopped\n    environment:\n      - NODE_ENV=production\n      - MONGO_URI=mongodb://mongodb:27017/mdm_validation\n      - JWT_SECRET=Kj8mN2pQ5rT7vX9zA3cF6hJ0lM4nP8qS1uW5xY2bD\n      - JWT_EXPIRATION=60m\n      - PORT=3001\n      - MAX_FILE_SIZE_MB=50\n      - FRONTEND_URL=http://72.61.52.70:5173\n    ports:\n      - \"\"3001:3001\"\"\n    depends_on:\n      - mongodb\n    networks:\n      - mdm-network\n    volumes:\n      - uploads_data:/app/uploads\n\n  # Frontend\n  frontend:\n    build:\n      context: ./frontend\n      dockerfile: Dockerfile\n    container_name: mdm-frontend\n    restart: unless-stopped\n    ports:\n      - \"\"5173:80\"\"\n    depends_on:\n      - backend\n    networks:\n      - mdm-network\n\nvolumes:\n  mongodb_data:\n  uploads_data:\n\nnetworks:\n  mdm-network:\n    driver: bridge\nEOF\")",
      "Bash(ssh root@72.61.52.70 \"cd /opt/mdm-validation && docker compose build --no-cache\")",
      "Bash(ssh root@72.61.52.70 \"cd /opt/mdm-validation && docker compose up -d\")",
      "Bash(ssh root@72.61.52.70 \"lsof -i :3001 || ss -tlnp | grep 3001\")",
      "Bash(ssh root@72.61.52.70 \"kill 1035 && sleep 2 && cd /opt/mdm-validation && docker compose up -d\")",
      "Bash(ssh root@72.61.52.70 \"lsof -i :5173 -t | xargs kill -9 2>/dev/null; sleep 2 && cd /opt/mdm-validation && docker compose up -d\")",
      "Bash(ssh root@72.61.52.70 \"pkill -f node; pkill -f vite; sleep 3 && cd /opt/mdm-validation && docker compose down && docker compose up -d\")",
      "Bash(ssh root@72.61.52.70 \"cd /opt/mdm-validation && docker compose down && docker compose up -d\")",
      "Bash(ssh root@72.61.52.70 \"fuser -k 3001/tcp 2>/dev/null; fuser -k 5173/tcp 2>/dev/null; sleep 2 && netstat -tlnp | grep -E ''3001|5173''\")",
      "Bash(ssh root@72.61.52.70 \"cat > /opt/mdm-validation/docker-compose.yml << ''EOF''\nservices:\n  # MongoDB\n  mongodb:\n    image: mongo:7.0\n    container_name: mdm-mongodb\n    restart: unless-stopped\n    environment:\n      MONGO_INITDB_DATABASE: mdm_validation\n    ports:\n      - \"\"27018:27017\"\"\n    volumes:\n      - mongodb_data:/data/db\n    networks:\n      - mdm-network\n\n  # Backend API\n  backend:\n    build:\n      context: ./backend\n      dockerfile: Dockerfile\n    container_name: mdm-backend\n    restart: unless-stopped\n    environment:\n      - NODE_ENV=production\n      - MONGO_URI=mongodb://mongodb:27017/mdm_validation\n      - JWT_SECRET=Kj8mN2pQ5rT7vX9zA3cF6hJ0lM4nP8qS1uW5xY2bD\n      - JWT_EXPIRATION=60m\n      - PORT=3001\n      - MAX_FILE_SIZE_MB=50\n      - FRONTEND_URL=http://72.61.52.70:8080\n    ports:\n      - \"\"3002:3001\"\"\n    depends_on:\n      - mongodb\n    networks:\n      - mdm-network\n    volumes:\n      - uploads_data:/app/uploads\n\n  # Frontend\n  frontend:\n    build:\n      context: ./frontend\n      dockerfile: Dockerfile\n    container_name: mdm-frontend\n    restart: unless-stopped\n    ports:\n      - \"\"8080:80\"\"\n    depends_on:\n      - backend\n    networks:\n      - mdm-network\n\nvolumes:\n  mongodb_data:\n  uploads_data:\n\nnetworks:\n  mdm-network:\n    driver: bridge\nEOF\")",
      "Bash(ssh root@72.61.52.70 \"cat > /opt/mdm-validation/frontend/nginx.conf << ''EOF''\nserver {\n    listen 80;\n    server_name localhost;\n    root /usr/share/nginx/html;\n    index index.html;\n\n    # Gzip compression\n    gzip on;\n    gzip_vary on;\n    gzip_min_length 1024;\n    gzip_proxied expired no-cache no-store private auth;\n    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript;\n\n    # API proxy\n    location /api {\n        proxy_pass http://backend:3001;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection ''upgrade'';\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_cache_bypass $http_upgrade;\n        proxy_read_timeout 300s;\n        proxy_connect_timeout 75s;\n        client_max_body_size 50M;\n    }\n\n    # SPA routing\n    location / {\n        try_files $uri $uri/ /index.html;\n    }\n\n    # Cache static assets\n    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {\n        expires 1y;\n        add_header Cache-Control \"\"public, immutable\"\";\n    }\n\n    # Security headers\n    add_header X-Frame-Options \"\"SAMEORIGIN\"\" always;\n    add_header X-Content-Type-Options \"\"nosniff\"\" always;\n    add_header X-XSS-Protection \"\"1; mode=block\"\" always;\n}\nEOF\")",
      "Bash(ssh root@72.61.52.70 \"cd /opt/mdm-validation && docker compose down && docker compose build frontend --no-cache && docker compose up -d\")",
      "Bash(ssh root@72.61.52.70 \"netstat -tlnp | grep -E ''LISTEN'' | head -30\")",
      "Bash(ssh root@72.61.52.70 \"cat > /opt/mdm-validation/docker-compose.yml << ''EOF''\nservices:\n  # MongoDB\n  mongodb:\n    image: mongo:7.0\n    container_name: mdm-mongodb\n    restart: unless-stopped\n    environment:\n      MONGO_INITDB_DATABASE: mdm_validation\n    ports:\n      - \"\"27019:27017\"\"\n    volumes:\n      - mongodb_data:/data/db\n    networks:\n      - mdm-network\n\n  # Backend API\n  backend:\n    build:\n      context: ./backend\n      dockerfile: Dockerfile\n    container_name: mdm-backend\n    restart: unless-stopped\n    environment:\n      - NODE_ENV=production\n      - MONGO_URI=mongodb://mongodb:27017/mdm_validation\n      - JWT_SECRET=Kj8mN2pQ5rT7vX9zA3cF6hJ0lM4nP8qS1uW5xY2bD\n      - JWT_EXPIRATION=60m\n      - PORT=3001\n      - MAX_FILE_SIZE_MB=50\n      - FRONTEND_URL=http://72.61.52.70:8081\n    ports:\n      - \"\"3003:3001\"\"\n    depends_on:\n      - mongodb\n    networks:\n      - mdm-network\n    volumes:\n      - uploads_data:/app/uploads\n\n  # Frontend\n  frontend:\n    build:\n      context: ./frontend\n      dockerfile: Dockerfile\n    container_name: mdm-frontend\n    restart: unless-stopped\n    ports:\n      - \"\"8081:80\"\"\n    depends_on:\n      - backend\n    networks:\n      - mdm-network\n\nvolumes:\n  mongodb_data:\n  uploads_data:\n\nnetworks:\n  mdm-network:\n    driver: bridge\nEOF\")",
      "Bash(ssh root@72.61.52.70 \"docker ps && docker logs mdm-backend --tail 20\")",
      "Bash(ssh root@72.61.52.70 \"docker exec mdm-backend node src/utils/seed.js\")",
      "Bash(ssh root@72.61.52.70 \"curl -s http://localhost:8081 | head -30 && echo ''---'' && curl -s http://localhost:3003/api/health\")",
      "Bash(ssh root@72.61.52.70 \"cd /opt/mdm-validation && docker compose down && docker compose build --no-cache && docker compose up -d\")",
      "Bash(ssh root@72.61.52.70 \"cd /opt/mdm-validation && docker compose build --no-cache && docker compose up -d\")",
      "Bash(ssh root@72.61.52.70 \"fuser -k 3001/tcp 2>/dev/null; sleep 2 && cd /opt/mdm-validation && docker compose up -d && docker ps\")",
      "Bash(ssh root@72.61.52.70 \"cat /opt/mdm-validation/docker-compose.yml\")",
      "Bash(ssh root@72.61.52.70 \"fuser -k 5173/tcp 2>/dev/null; fuser -k 3001/tcp 2>/dev/null; fuser -k 27017/tcp 2>/dev/null; sleep 2\")",
      "Bash(ssh root@72.61.52.70 \"cd /opt/mdm-validation && docker compose down && docker compose up -d && sleep 5 && docker ps && docker logs mdm-backend --tail 10\")",
      "Bash(ssh root@72.61.52.70 \"netstat -tlnp | grep -E ''3001|5173|27017'' && lsof -i :3001 2>/dev/null || true\")",
      "Bash(ssh root@72.61.52.70 \"kill -9 353646 353639 2>/dev/null; sleep 2 && cd /opt/mdm-validation && docker compose up -d && docker ps\")",
      "Bash(ssh root@72.61.52.70 \"lsof -i :5173 -t | xargs -r kill -9; sleep 2 && cd /opt/mdm-validation && docker compose up -d && docker ps\")",
      "Bash(ssh root@72.61.52.70 \"pm2 list 2>/dev/null || echo ''pm2 not found''; systemctl list-units --type=service --state=running | grep -i node 2>/dev/null || echo ''No node services''\")",
      "Bash(ssh root@72.61.52.70 \"cd /opt/mdm-validation && docker compose down && docker compose up -d && docker ps\")",
      "Bash(ssh:*)",
      "Bash(npm install:*)",
      "Bash(git init:*)",
      "Bash(git remote add:*)",
      "Bash(git branch:*)",
      "Bash(git add:*)"
    ],
    "deny": [],
    "ask": []
  }
}
